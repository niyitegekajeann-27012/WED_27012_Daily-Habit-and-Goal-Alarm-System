-- PHASE VII: ADVANCED DATABASE PROGRAMMING AND AUDITING


-- HOLIDAY TABLE

CREATE TABLE public_holidays (
    holiday_date DATE PRIMARY KEY,
    description  VARCHAR2(100)
);

-- Insert example holidays
INSERT INTO public_holidays VALUES (TO_DATE('01-JUN-2025', 'DD-MON-YYYY'), 'National Heroes Day');
INSERT INTO public_holidays VALUES (TO_DATE('10-JUN-2025', 'DD-MON-YYYY'), 'Independence Day');
INSERT INTO public_holidays VALUES (TO_DATE('30-JUN-2025', 'DD-MON-YYYY'), 'Cultural Celebration');


-- RESTRICTION TRIGGER (Prevent Weekday and Holiday DML)

CREATE OR REPLACE TRIGGER restrict_weekday_and_holiday_dml
BEFORE INSERT OR UPDATE OR DELETE ON habit
FOR EACH ROW
DECLARE
  v_day   VARCHAR2(10);
  v_holiday NUMBER;
BEGIN
  SELECT TRIM(TO_CHAR(SYSDATE, 'DAY', 'NLS_DATE_LANGUAGE=ENGLISH')) INTO v_day FROM dual;

  SELECT COUNT(*) INTO v_holiday
  FROM public_holidays
  WHERE holiday_date = TRUNC(SYSDATE);

  IF v_day IN ('MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY') OR v_holiday > 0 THEN
    RAISE_APPLICATION_ERROR(-20001, 'DML is blocked on weekdays and public holidays!');
  END IF;
END;




-- Auditing table

CREATE TABLE audit_log (
    audit_id     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id      NUMBER,
    action_date  DATE DEFAULT SYSDATE,
    operation    VARCHAR2(50),
    status       VARCHAR2(20) -- 'allowed' or 'denied'
);




-- Auditing trigger and status logging

CREATE OR REPLACE TRIGGER audit_habit_dml
AFTER INSERT OR UPDATE OR DELETE ON habit
FOR EACH ROW
DECLARE
  v_user_id NUMBER := 1; -- Simulated, in real app get current session user
BEGIN
  INSERT INTO audit_log (user_id, operation, status)
  VALUES (v_user_id, 'MODIFY HABIT', 'allowed');
END;


-- operations to test trigger trigger

INSERT INTO habit (user_id, title, description, frequency, start_date)
VALUES (2, 'Wake up early', 'Wake up by 5AM daily', 'daily', SYSDATE);

UPDATE habit SET status = 'paused' WHERE habit_id = 1;

DELETE FROM habit WHERE habit_id = 1;


--test
SELECT * FROM audit_log ORDER BY audit_id;



