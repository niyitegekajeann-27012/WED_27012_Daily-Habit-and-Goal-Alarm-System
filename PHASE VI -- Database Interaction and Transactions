-- PHASE VI: DATABASE INTERACTION AND TRANSACTIONS


-- DML & DDL


-- UPDATE
UPDATE goal
SET status = 'achieved'
WHERE goal_id = 5;

-- DELETE
DELETE FROM habit_log
WHERE status = 'missed';




-- CREATING A PROCEDURE FETCH HABIT LOGS


CREATE OR REPLACE PROCEDURE get_habit_logs (
  p_user_id IN NUMBER
)
IS
BEGIN
  FOR rec IN (
    SELECT h.title, l.log_date, l.status
    FROM habit h
    JOIN habit_log l ON h.habit_id = l.habit_id
    WHERE h.user_id = p_user_id
  ) LOOP
    DBMS_OUTPUT.PUT_LINE('Habit: ' || rec.title || ' | Date: ' || rec.log_date || ' | Status: ' || rec.status);
  END LOOP;
END;



EXEC get_habit_logs(1);






-- FUNCTION CALCULATE GOAL COMPLETION % FROM LOGS

CREATE OR REPLACE FUNCTION get_goal_completion (
  p_goal_id IN NUMBER
) RETURN NUMBER
IS
  v_percent NUMBER;
BEGIN
  SELECT completion_percentage INTO v_percent
  FROM goal_status
  WHERE goal_id = p_goal_id
  ORDER BY update_date DESC
  FETCH FIRST 1 ROWS ONLY;

  RETURN v_percent;
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    RETURN 0;
END;



SELECT get_goal_completion(1) FROM dual;






-- CURSOR WITH EXCEPTION HANDLING


DECLARE
  CURSOR cur_habits IS
    SELECT title FROM habit WHERE user_id = 1;

  v_title habit.title%TYPE;
BEGIN
  OPEN cur_habits;
  LOOP
    FETCH cur_habits INTO v_title;
    EXIT WHEN cur_habits%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE('Habit: ' || v_title);
  END LOOP;
  CLOSE cur_habits;
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;






-- PACKAGE EXAMPLE


CREATE OR REPLACE PACKAGE habit_pkg AS
  PROCEDURE log_today_habit(p_habit_id IN NUMBER, p_status IN VARCHAR2);
  FUNCTION active_habit_count(p_user_id IN NUMBER) RETURN NUMBER;
END habit_pkg;
/

CREATE OR REPLACE PACKAGE BODY habit_pkg AS

  PROCEDURE log_today_habit(p_habit_id IN NUMBER, p_status IN VARCHAR2) IS
  BEGIN
    INSERT INTO habit_log (habit_id, log_date, status)
    VALUES (p_habit_id, SYSDATE, p_status);
  END;

  FUNCTION active_habit_count(p_user_id IN NUMBER) RETURN NUMBER IS
    v_count NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_count FROM habit
    WHERE user_id = p_user_id AND status = 'active';
    RETURN v_count;
  END;

END habit_pkg;





--RUN 
EXEC habit_pkg.log_today_habit(1, 'completed');
SELECT habit_pkg.active_habit_count(1) FROM dual;
